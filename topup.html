<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Isi Saldo ‚Ä¢ GabutStore VPN Tunnels</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="navbar">
  <div class="container nav-inner">
    <a href="index.html" class="brand-logo">
      GabutStore VPN Tunnels
    </a>

    <nav class="main-nav" id="mainNav">
      <ul>
        <li><a href="index.html">Beranda</a></li>
        <li><a href="pricing.html" class="active">üí∞ Isi Saldo</a></li>
        <li><a href="guide.html">‚öôÔ∏è Cara Penggunaan</a></li>
        <li><a href="contact.html">üìû Kontak & Support</a></li>
      </ul>
    </nav>

    <div class="nav-actions">
      <a href="order.html" class="btn btn-secondary">
        Buat Akun
      </a>
      <a href="login.html" class="btn btn-primary">
        Area Pelanggan
      </a>
    </div>

    <button class="menu-toggle" id="menuToggle">‚ò∞</button>
  </div>
</header>

<main class="pricing-page">
  <div class="container">

    <header class="pricing-header">
      <h1>Konfirmasi Isi Saldo</h1>
      <p>
        Saldo akan masuk ke akun bot kamu dan bisa dipakai beli semua protokol
        (VMESS / VLESS / Trojan / SSH) dari web atau bot.
      </p>
    </header>

    <section class="pricing-grid">
      <article class="pricing-card pricing-card-highlight">
        <div class="pricing-label hot">Pembayaran QRIS otomatis</div>

        <h2 id="topup-title">Isi Saldo</h2>

        <p class="pricing-desc" id="topup-desc">
          Nominal akan diambil dari paket yang kamu pilih di halaman sebelumnya.
        </p>

        <ul class="pricing-features">
          <li>Pembayaran via Pakasir (QRIS)</li>
          <li>Saldo tersimpan di database yang sama dengan bot</li>
          <li>Setelah bayar & webhook sukses, saldo otomatis bertambah</li>
        </ul>

        <div class="field">
          <label for="user-id">User ID Telegram kamu</label>
          <input id="user-id" type="number" placeholder="Contoh: 123456789">
          <div class="note">
            User ID ini sama dengan yang dipakai di bot.  
            Bisa dicek di bot /menu jika kamu lupa.
          </div>
        </div>

        <button id="btn-topup" class="btn btn-primary btn-full">
          üßæ Buat QRIS Pembayaran
        </button>

        <div id="status" class="note" style="margin-top:6px;"></div>
      </article>
    </section>

    <p class="pricing-note">
      Setelah klik "Buat QRIS Pembayaran", kamu akan diarahkan ke halaman pembayaran Pakasir.  
      Jangan tutup sebelum pembayaran selesai.
    </p>

  </div>
</main>

<footer>
  <div class="container">
    <p>&copy; 2025 XtrimerStore. All rights reserved.</p>
  </div>
</footer>

<script src="script.js"></script>
<script>
  // === CONFIG: samakan dengan domain backend kamu ===
  const API_BASE = "https://api.rmpremium.cloud";
  const TOPUP_ENDPOINT = API_BASE + "/api/web/topup";

  const urlParams = new URLSearchParams(window.location.search);
  const amountParam = parseInt(urlParams.get("amount") || "0", 10);

  const titleEl = document.getElementById("topup-title");
  const descEl = document.getElementById("topup-desc");
  const btnTopup = document.getElementById("btn-topup");
  const userIdInput = document.getElementById("user-id");
  const statusEl = document.getElementById("status");

  let topupAmount = amountParam > 0 ? amountParam : 0;

  function formatRupiah(n) {
    return "Rp " + Number(n || 0).toLocaleString("id-ID");
  }

  // Set teks berdasarkan amount dari URL (?amount=5000 dll)
  if (topupAmount > 0) {
    titleEl.textContent = "Isi Saldo " + formatRupiah(topupAmount);
    descEl.textContent = "Kamu akan mengisi saldo sebesar " + formatRupiah(topupAmount) + ".";
    btnTopup.textContent = "üßæ Bayar " + formatRupiah(topupAmount) + " via QRIS";
  } else {
    titleEl.textContent = "Isi Saldo";
    descEl.textContent = "Pilih nominal dari halaman Isi Saldo, lalu kamu akan diarahkan ke sini.";
  }

  async function handleTopup() {
    statusEl.textContent = "";
    statusEl.className = "note";

    const userId = parseInt(userIdInput.value, 10);

    if (!topupAmount || topupAmount <= 0) {
      statusEl.textContent = "Nominal saldo tidak ditemukan. Silakan kembali ke halaman Isi Saldo.";
      statusEl.className = "error";
      return;
    }

    if (!userId) {
      statusEl.textContent = "User ID Telegram belum diisi.";
      statusEl.className = "error";
      return;
    }

    btnTopup.disabled = true;
    btnTopup.textContent = "Memproses...";
    statusEl.textContent = "Menghubungi server pembayaran...";
    statusEl.className = "note";

    try {
      const res = await fetch(TOPUP_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: userId,
          amount: topupAmount
        })
      });

      const data = await res.json();

      if (!data.success) {
        statusEl.textContent = "Gagal membuat pembayaran: " + (data.error || "error tidak diketahui");
        statusEl.className = "error";
        btnTopup.disabled = false;
        btnTopup.textContent = "üßæ Buat QRIS Pembayaran";
        return;
      }

      // Redirect ke halaman bayar Pakasir
      statusEl.textContent = "Berhasil membuat invoice. Mengarahkan ke halaman pembayaran...";
      statusEl.className = "success";

      if (data.payment_url) {
        window.location.href = data.payment_url;
      } else {
        statusEl.textContent = "Payment URL tidak ditemukan di respon server.";
        statusEl.className = "error";
        btnTopup.disabled = false;
        btnTopup.textContent = "üßæ Buat QRIS Pembayaran";
      }

    } catch (err) {
      console.error(err);
      statusEl.textContent = "Gagal terhubung ke backend. Cek koneksi / domain API.";
      statusEl.className = "error";
      btnTopup.disabled = false;
      btnTopup.textContent = "üßæ Buat QRIS Pembayaran";
    }
  }

  btnTopup.addEventListener("click", handleTopup);
</script>
</body>
</html>
