<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>ExtrimerS Tunneling - Simple Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #e5e7eb;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }
    header {
      padding: 16px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header span.brand-pill {
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(to right, #22c55e, #06b6d4);
      color: #020617;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }
    header small {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 20px;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #111827;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.8);
    }
    .servers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 12px;
    }
    .server-card {
      border-radius: 10px;
      padding: 12px;
      background: linear-gradient(to bottom right, #0b1120, #020617);
      border: 1px solid #1f2937;
    }
    .server-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .location {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 6px;
    }
    .server-meta {
      font-size: 0.8rem;
      color: #9ca3af;
      line-height: 1.4;
    }
    .server-status {
      margin-top: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-ok { color: #22c55e; }
    .status-full { color: #ef4444; }
    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, #1f2937, transparent);
      margin: 12px 0;
    }
    label {
      display: block;
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    input, select, button, textarea {
      font-family: inherit;
      font-size: 0.9rem;
    }
    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      outline: none;
      box-sizing: border-box;
    }
    button.primary {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(to right, #22c55e, #06b6d4);
      color: #020617;
    }
    .error { color: #f97316; font-size: 0.8rem; }
    .success { color: #22c55e; font-size: 0.8rem; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>
          ‚ö° ExtrimerS Tunneling <span class="brand-pill">Simple Store</span>
        </h1>
        <small>Koneksi cepat & stabil ‚Ä¢ Sistem otomatis ‚Ä¢ Config langsung jadi</small>
      </div>
      <div>
        <span class="badge">API: <span id="api-label">loading‚Ä¶</span></span>
      </div>
    </header>

    <main>
      <!-- SERVER LIST -->
      <section class="card">
        <h2>üì° Pilih Server</h2>
        <div class="divider"></div>
        <div id="servers" class="servers-grid">
          <p style="color:#9ca3af;font-size:0.85rem;">Mengambil data server‚Ä¶</p>
        </div>
      </section>

      <!-- ORDER -->
      <section class="card">
        <h2>üßæ Buat Akun VMESS</h2>

        <div class="field">
          <label for="server-select">Server</label>
          <select id="server-select">
            <option value="">Pilih server‚Ä¶</option>
          </select>
        </div>

        <div class="field">
          <label for="username">Username</label>
          <input id="username" type="text" placeholder="contoh: extrimers01" />
        </div>

        <div class="field">
          <label for="days">Durasi Hari</label>
          <select id="days">
            <option value="7">7 Hari</option>
            <option value="15">15 Hari</option>
            <option value="30" selected>30 Hari</option>
          </select>
        </div>

        <div class="field">
          <label for="user-id">User ID backend</label>
          <input id="user-id" type="number" value="123456789" />
        </div>

        <button id="btn-order" class="primary">üöÄ Buat Akun Sekarang</button>
        <div id="status" class="note"></div>

        <div class="field">
          <label>Hasil / Config</label>
          <textarea id="result" readonly></textarea>
        </div>
      </section>
    </main>
  </div>

  <footer style="text-align:center;margin:12px;color:#6b7280;font-size:0.75rem;">
    Powered by API <span id="api-label-footer"></span>
  </footer>

  <script>
    // ====================================
    // AUTO DETECT ORIGIN (VERCEL PROXY)
    // ====================================
    const API_BASE = ""; // same-origin
    const serversEndpoint = "/api/web/servers";
    const orderEndpoint   = "/api/web/order";

    document.getElementById("api-label").textContent = window.location.origin;
    document.getElementById("api-label-footer").textContent = window.location.origin;

    const serversDiv = document.getElementById("servers");
    const serverSelect = document.getElementById("server-select");
    const usernameInput = document.getElementById("username");
    const daysSelect = document.getElementById("days");
    const userIdInput = document.getElementById("user-id");
    const orderBtn = document.getElementById("btn-order");
    const resultArea = document.getElementById("result");
    const statusEl = document.getElementById("status");

    // ===========================
    // LOAD SERVER LIST
    // ===========================
    async function loadServers() {
      try {
        const res = await fetch(serversEndpoint);
        const data = await res.json();

        if (!data.success) {
          serversDiv.innerHTML = "<p style='color:#f97316;'>Gagal mengambil server.</p>";
          return;
        }

        serversDiv.innerHTML = "";
        serverSelect.innerHTML = "<option value=''>Pilih server‚Ä¶</option>";

        data.servers.forEach(s => {
          const full = s.total_create_akun >= s.batas_create_akun;

          const card = document.createElement("div");
          card.className = "server-card";
          card.innerHTML = `
            <div class="server-name">${s.nama_server}</div>
            <div class="location">${s.lokasi || "-"}</div>
            <div class="server-meta">
              Harga / hari: <b>Rp${s.harga.toLocaleString("id-ID")}</b><br/>
              Kuota / hari: <b>${s.quota} GB</b><br/>
              IP Limit: <b>${s.iplimit}</b><br/>
              Akun: <b>${s.total_create_akun}/${s.batas_create_akun}</b>
            </div>
            <div class="server-status ${full ? "status-full" : "status-ok"}">
              ${full ? "‚ùå PENUH" : "‚úÖ Tersedia"}
            </div>
          `;
          card.onclick = () => serverSelect.value = s.id;
          serversDiv.appendChild(card);

          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = `${s.nama_server} (${s.lokasi || "-"})`;
          serverSelect.appendChild(opt);
        });

      } catch {
        serversDiv.innerHTML = "<p style='color:#f97316;'>Tidak bisa connect ke API.</p>";
      }
    }

    loadServers();

    // ===========================
    // ORDER
    // ===========================
    async function handleOrder() {
      statusEl.textContent = "";
      resultArea.value = "";

      const serverId = serverSelect.value;
      const username = usernameInput.value.trim();
      const days = parseInt(daysSelect.value);
      const userId = parseInt(userIdInput.value);

      if (!serverId) return statusEl.textContent = "Pilih server.";
      if (!/^[a-zA-Z0-9]{3,20}$/.test(username))
        return statusEl.textContent = "Username tidak valid.";
      if (!userId) return statusEl.textContent = "User ID kosong.";

      orderBtn.disabled = true;
      statusEl.textContent = "Menghubungi server‚Ä¶";

      try {
        const res = await fetch(orderEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "create",
            type: "vmess",
            user_id: userId,
            server_id: Number(serverId),
            username: username,
            password: "123",
            days: days
          })
        });

        const data = await res.json();

        if (!data.success) {
          statusEl.textContent = "Gagal: " + data.error;
          statusEl.className = "error";
          return;
        }

        statusEl.textContent = "Berhasil!";
        statusEl.className = "success";
        resultArea.value = data.message;

      } catch {
        statusEl.textContent = "Gagal terhubung ke API.";
        statusEl.className = "error";
      }

      orderBtn.disabled = false;
    }

    orderBtn.onclick = handleOrder;
  </script>
</body>
</html>
