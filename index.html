<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Tun Xtrimer - Auto Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* animasi simple */
    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <!-- Background gradient -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-indigo-600/30 via-slate-950 to-fuchsia-600/20"></div>
    <div class="absolute inset-0 backdrop-blur-sm"></div>
  </div>

  <div class="min-h-screen flex items-center justify-center px-4">
    <div class="w-full max-w-3xl">
      <!-- Card utama -->
      <div class="bg-slate-900/80 border border-slate-700/60 rounded-3xl shadow-2xl shadow-black/40 p-6 sm:p-8 fade-in">

        <!-- HEADER -->
        <header class="flex items-center justify-between gap-4 mb-6">
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-2xl bg-gradient-to-tr from-indigo-500 to-fuchsia-500 flex items-center justify-center font-bold text-xl">
              T
            </div>
            <div>
              <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">
                Tun Xtrimer
              </h1>
              <p class="text-xs sm:text-sm text-slate-400">
                Panel Auto Order via Web
              </p>
            </div>
          </div>
          <span class="hidden sm:inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-slate-800/70 border border-slate-700">
            <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
            Online
          </span>
        </header>

        <!-- ALERT / TOAST -->
        <div id="toast" class="hidden mb-4">
          <div class="text-sm px-4 py-3 rounded-2xl border flex items-center justify-between gap-3" id="toast-inner"></div>
        </div>

        <!-- SECTION: WELCOME / LOGIN -->
        <section id="welcome-section" class="space-y-6">
          <div>
            <h2 class="text-lg sm:text-xl font-semibold mb-1">
              Selamat datang, bosku ðŸ‘‹
            </h2>
            <p class="text-sm text-slate-400">
              Masukin aja <span class="font-medium text-slate-200">email dan password bebas</span>. 
              Cuma buat identitas di web ini, bukan akun asli apa pun.
            </p>
          </div>

          <form id="login-form" class="space-y-4 mt-4">
            <div>
              <label class="block text-xs font-medium text-slate-300 mb-1.5">
                Email Bebas
              </label>
              <input
                id="login-email"
                type="email"
                placeholder="contoh: userganteng@bebas.com"
                class="w-full rounded-2xl border border-slate-700 bg-slate-900/80 px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 placeholder:text-slate-500"
                required
              />
            </div>

            <div>
              <label class="block text-xs font-medium text-slate-300 mb-1.5">
                Password Bebas
              </label>
              <input
                id="login-password"
                type="password"
                placeholder="isi sesuka hati..."
                class="w-full rounded-2xl border border-slate-700 bg-slate-900/80 px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 placeholder:text-slate-500"
                required
              />
              <p class="mt-1 text-[11px] text-slate-500">
                *Data ini cuma disimpan di perangkat kamu (localStorage browser).
              </p>
            </div>

            <button
              type="submit"
              class="w-full mt-3 inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-indigo-500 to-fuchsia-500 px-4 py-2.5 text-sm font-medium shadow-lg shadow-indigo-900/40 hover:opacity-90 active:scale-[0.98] transition"
            >
              Masuk ke Panel
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M5 12h14" stroke-width="1.8" stroke-linecap="round"/>
                <path d="M13 6l6 6-6 6" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </form>
        </section>

        <!-- SECTION: APP / AUTO ORDER -->
        <section id="app-section" class="hidden space-y-6">
          <!-- Info user -->
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-xs text-slate-400">
                Login sebagai
              </p>
              <p class="text-sm font-medium" id="display-email">user@bebas.com</p>
            </div>
            <button
              id="logout-btn"
              class="text-xs px-3 py-1.5 rounded-full border border-slate-700/80 bg-slate-900/70 hover:bg-slate-800/80 transition"
            >
              Ganti akun
            </button>
          </div>

          <!-- Form Order -->
          <div class="grid gap-5 md:grid-cols-[1.3fr_minmax(0,1fr)] items-start">
            <form id="order-form" class="space-y-4 bg-slate-900/60 border border-slate-700/70 rounded-2xl p-4">
              <h3 class="text-sm font-semibold mb-1 flex items-center gap-2">
                Buat Akun Baru
                <span class="text-[10px] px-2 py-0.5 rounded-full bg-slate-800 text-slate-300 border border-slate-700">
                  Auto Order
                </span>
              </h3>

              <!-- Server -->
              <div>
                <label class="block text-xs font-medium text-slate-300 mb-1.5">
                  Pilih Server
                </label>
                <select
                  id="server-select"
                  class="w-full text-sm rounded-2xl border border-slate-700 bg-slate-950/80 px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-60"
                  required
                >
                  <option value="">Loading server...</option>
                </select>
                <p class="mt-1 text-[11px] text-slate-500">
                  Diambil otomatis dari API <code class="text-[10px] bg-slate-800/80 px-1.5 py-0.5 rounded">/api/web/servers</code>
                </p>
              </div>

              <!-- Tipe akun -->
              <div>
                <label class="block text-xs font-medium text-slate-300 mb-1.5">
                  Tipe Akun
                </label>
                <select
                  id="type-select"
                  class="w-full text-sm rounded-2xl border border-slate-700 bg-slate-950/80 px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  required
                >
                  <option value="ssh">SSH</option>
                  <option value="vmess">VMess</option>
                  <option value="vless">VLESS</option>
                  <option value="trojan">Trojan</option>
                  <option value="shadowsocks">Shadowsocks</option>
                </select>
              </div>

              <!-- Username & hari -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-slate-300 mb-1.5">
                    Username
                  </label>
                  <input
                    id="username-input"
                    type="text"
                    placeholder="contoh: user1"
                    class="w-full rounded-2xl border border-slate-700 bg-slate-900/80 px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 placeholder:text-slate-500"
                    required
                  />
                </div>
                <div>
                  <label class="block text-xs font-medium text-slate-300 mb-1.5">
                    Masa Aktif (hari)
                  </label>
                  <input
                    id="days-input"
                    type="number"
                    min="1"
                    max="365"
                    value="3"
                    class="w-full rounded-2xl border border-slate-700 bg-slate-900/80 px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    required
                  />
                </div>
              </div>

              <!-- Catatan -->
              <div>
                <label class="block text-xs font-medium text-slate-300 mb-1.5">
                  Catatan (opsional)
                </label>
                <textarea
                  id="note-input"
                  rows="2"
                  placeholder="contoh: buat member A, paket bulanan..."
                  class="w-full rounded-2xl border border-slate-700 bg-slate-900/80 px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 placeholder:text-slate-500"
                ></textarea>
              </div>

              <button
                type="submit"
                id="order-submit"
                class="w-full mt-2 inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-emerald-500 to-lime-500 px-4 py-2.5 text-sm font-semibold text-slate-900 shadow-lg shadow-emerald-900/40 hover:opacity-90 active:scale-[0.98] transition disabled:opacity-60 disabled:cursor-not-allowed"
              >
                Buat Akun Sekarang
              </button>
            </form>

            <!-- Hasil -->
            <div class="space-y-3">
              <div class="bg-slate-900/60 border border-slate-700/70 rounded-2xl p-4 min-h-[160px]">
                <h3 class="text-sm font-semibold mb-2">
                  Hasil Akun
                </h3>
                <div id="result-box" class="text-xs text-slate-400 whitespace-pre-wrap">
                  Belum ada akun yang dibuat.  
                  Setelah berhasil, detail akun bakal muncul di sini.
                </div>
              </div>

              <button
                id="copy-result-btn"
                class="w-full text-xs inline-flex items-center justify-center gap-2 rounded-2xl border border-slate-700 bg-slate-900/80 px-3 py-2 hover:bg-slate-800/80 transition disabled:opacity-50"
                disabled
              >
                Copy Detail Akun
              </button>
            </div>
          </div>
        </section>

      </div>

      <!-- Footer kecil -->
      <p class="mt-4 text-[11px] text-slate-500 text-center">
        Tun Xtrimer &mdash; Auto Order Web Â· <span class="text-slate-400">tun.xtrimer.cloud</span>
      </p>
    </div>
  </div>

  <script>
    // ====== UTIL: Toast ======
    function showToast(message, type = "info") {
      const toast = document.getElementById("toast");
      const inner = document.getElementById("toast-inner");

      const baseClasses =
        "text-sm px-4 py-3 rounded-2xl border flex items-center justify-between gap-3 w-full";

      let extraClasses = "";
      if (type === "success") {
        extraClasses = "bg-emerald-500/10 border-emerald-500/40 text-emerald-200";
      } else if (type === "error") {
        extraClasses = "bg-rose-500/10 border-rose-500/40 text-rose-200";
      } else {
        extraClasses = "bg-slate-800/80 border-slate-600 text-slate-100";
      }

      inner.className = baseClasses + " " + extraClasses;
      inner.innerHTML = `
        <span>${message}</span>
        <button class="text-[11px] uppercase tracking-wide" onclick="document.getElementById('toast').classList.add('hidden')">
          Tutup
        </button>
      `;
      toast.classList.remove("hidden");

      // auto-hide
      setTimeout(() => {
        toast.classList.add("hidden");
      }, 5000);
    }

    // ====== STATE LOCALSTORAGE ======
    const STORAGE_KEY = "tunxtrimer_user";

    function saveUser(email, password) {
      localStorage.setItem(
        STORAGE_KEY,
        JSON.stringify({ email, password, savedAt: Date.now() })
      );
    }

    function getUser() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        return null;
      }
    }

    function clearUser() {
      localStorage.removeItem(STORAGE_KEY);
    }

    // ====== UI SWITCH ======
    const welcomeSection = document.getElementById("welcome-section");
    const appSection = document.getElementById("app-section");
    const displayEmail = document.getElementById("display-email");
    const logoutBtn = document.getElementById("logout-btn");

    function showApp(user) {
      if (user && user.email) {
        displayEmail.textContent = user.email;
      }
      welcomeSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      // load servers ketika masuk app
      fetchServers();
    }

    function showWelcome() {
      welcomeSection.classList.remove("hidden");
      appSection.classList.add("hidden");
    }

    // ====== LOGIN FORM ======
    const loginForm = document.getElementById("login-form");
    const loginEmail = document.getElementById("login-email");
    const loginPassword = document.getElementById("login-password");

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = loginEmail.value.trim();
      const password = loginPassword.value.trim();

      if (!email || !password) {
        showToast("Email dan password bebas nggak boleh kosong.", "error");
        return;
      }

      saveUser(email, password);
      showToast("Login berhasil. Selamat datang, bosku!", "success");
      showApp({ email, password });
    });

    logoutBtn.addEventListener("click", () => {
      clearUser();
      showToast("Akun lokal dibersihkan. Silakan login lagi.", "info");
      showWelcome();
    });

    // ====== FETCH SERVERS ======
    const serverSelect = document.getElementById("server-select");

    async function fetchServers() {
      serverSelect.innerHTML = '<option value="">Loading server...</option>';
      serverSelect.disabled = true;

      try {
        // Asumsi response: { success: true, servers: [{id, name, location, note}] }
        const res = await fetch("/api/web/servers");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const servers = Array.isArray(data.servers) ? data.servers : [];
        if (!servers.length) {
          serverSelect.innerHTML =
            '<option value="">Tidak ada server tersedia</option>';
          showToast("Belum ada server dari API /api/web/servers.", "info");
        } else {
          serverSelect.innerHTML = '<option value="">Pilih server...</option>';
          servers.forEach((srv) => {
            const opt = document.createElement("option");
            opt.value = srv.id ?? srv.code ?? srv.name;
            const extra =
              (srv.location ? ` â€¢ ${srv.location}` : "") +
              (srv.note ? ` (${srv.note})` : "");
            opt.textContent = `${srv.name || "Server"}${extra}`;
            serverSelect.appendChild(opt);
          });
        }
      } catch (err) {
        console.error(err);
        serverSelect.innerHTML =
          '<option value="">Gagal load server (cek API)</option>';
        showToast("Gagal mengambil list server dari API.", "error");
      } finally {
        serverSelect.disabled = false;
      }
    }

    // ====== ORDER FORM ======
    const orderForm = document.getElementById("order-form");
    const typeSelect = document.getElementById("type-select");
    const usernameInput = document.getElementById("username-input");
    const daysInput = document.getElementById("days-input");
    const noteInput = document.getElementById("note-input");
    const orderSubmit = document.getElementById("order-submit");
    const resultBox = document.getElementById("result-box");
    const copyResultBtn = document.getElementById("copy-result-btn");

    orderForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = getUser();
      if (!user) {
        showToast("Silakan login dulu sebelum buat akun.", "error");
        showWelcome();
        return;
      }

      const server = serverSelect.value;
      const type = typeSelect.value;
      const username = usernameInput.value.trim();
      const days = Number(daysInput.value || 0);
      const note = noteInput.value.trim();

      if (!server) {
        showToast("Pilih server dulu, bosku.", "error");
        return;
      }
      if (!username) {
        showToast("Username tidak boleh kosong.", "error");
        return;
      }
      if (!days || days < 1) {
        showToast("Minimal 1 hari masa aktif.", "error");
        return;
      }

      orderSubmit.disabled = true;
      orderSubmit.textContent = "Memproses...";

      try {
        // Asumsi API backend nanti terima payload seperti ini
        const payload = {
          email: user.email,
          password: user.password,
          server,
          type,
          username,
          days,
          note,
        };

        const res = await fetch("/api/web/order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const data = await res.json();

        if (data.status === "error" || data.success === false) {
          const msg = data.message || data.error || "Gagal membuat akun.";
          showToast(msg, "error");
          resultBox.textContent = msg;
          copyResultBtn.disabled = true;
          return;
        }

        // Asumsi data.account_text berisi text siap kirim, kalau tidak ada kita format sendiri
        let text = data.account_text;
        if (!text) {
          text = "Akun berhasil dibuat.\n\n" + JSON.stringify(data, null, 2);
        }

        resultBox.textContent = text;
        copyResultBtn.disabled = false;
        showToast("Akun berhasil dibuat ðŸš€", "success");
      } catch (err) {
        console.error(err);
        showToast("Terjadi error saat membuat akun. Cek log backend.", "error");
        resultBox.textContent =
          "Gagal membuat akun.\n\nDetail error (frontend): " + err.message;
        copyResultBtn.disabled = true;
      } finally {
        orderSubmit.disabled = false;
        orderSubmit.textContent = "Buat Akun Sekarang";
      }
    });

    // ====== COPY RESULT ======
    copyResultBtn.addEventListener("click", async () => {
      const text = resultBox.textContent.trim();
      if (!text) return;

      try {
        await navigator.clipboard.writeText(text);
        showToast("Detail akun berhasil dicopy ke clipboard.", "success");
      } catch (err) {
        showToast("Gagal copy ke clipboard.", "error");
      }
    });

    // ====== INIT ======
    document.addEventListener("DOMContentLoaded", () => {
      const user = getUser();
      if (user && user.email) {
        // auto login
        showApp(user);
      } else {
        showWelcome();
      }
    });
  </script>
</body>
  </html>
