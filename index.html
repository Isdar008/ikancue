<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>ExtrimerS Tunneling - Simple Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #e5e7eb;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }
    header {
      padding: 16px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header span.brand-pill {
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(to right, #22c55e, #06b6d4);
      color: #020617;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }
    header small {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 20px;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #111827;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.8);
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.1rem;
    }
    .badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #1f2937;
      color: #9ca3af;
    }
    .servers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 12px;
    }
    .server-card {
      border-radius: 10px;
      padding: 12px;
      background: linear-gradient(to bottom right, #0b1120, #020617);
      border: 1px solid #1f2937;
    }
    .server-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .location {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 6px;
    }
    .server-meta {
      font-size: 0.8rem;
      color: #9ca3af;
      line-height: 1.4;
    }
    .server-status {
      margin-top: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-ok {
      color: #22c55e;
    }
    .status-full {
      color: #ef4444;
    }
    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, #1f2937, transparent);
      margin: 12px 0;
    }
    label {
      display: block;
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    input, select, button, textarea {
      font-family: inherit;
      font-size: 0.9rem;
    }
    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      outline: none;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35);
    }
    .field {
      margin-bottom: 10px;
    }
    button.primary {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(to right, #22c55e, #06b6d4);
      color: #020617;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    button.primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .note {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 6px;
    }
    textarea {
      width: 100%;
      min-height: 140px;
      border-radius: 10px;
      padding: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      resize: vertical;
      box-sizing: border-box;
      font-size: 0.78rem;
      white-space: pre-wrap;
    }
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    .pill {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #9ca3af;
    }
    footer {
      padding: 10px 16px 18px;
      text-align: center;
      font-size: 0.75rem;
      color: #6b7280;
    }
    .error {
      color: #f97316;
      font-size: 0.8rem;
      margin-top: 4px;
    }
    .success {
      color: #22c55e;
      font-size: 0.8rem;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>
          <span>‚ö° ExtrimerS Tunneling</span>
          <span class="brand-pill">Simple Store</span>
        </h1>
        <small>Koneksi cepat & stabil ‚Ä¢ Sistem otomatis ‚Ä¢ Config langsung jadi</small>
      </div>
      <div>
        <span class="badge">API: <span id="api-label">loading‚Ä¶</span></span>
      </div>
    </header>

    <main>
      <!-- Kiri: List Server -->
      <section class="card">
        <h2>üì° Pilih Server</h2>
        <p style="font-size:0.84rem;color:#9ca3af;margin-top:4px;">
          Pilih server yang tersedia untuk membuat akun VMESS.  
          Status penuh artinya server sudah mencapai batas pembuatan akun harian.
        </p>
        <div class="divider"></div>
        <div id="servers" class="servers-grid">
          <p style="font-size:0.85rem;color:#9ca3af;">Mengambil data server‚Ä¶</p>
        </div>
      </section>

      <!-- Kanan: Form Order -->
      <section class="card">
        <h2>üßæ Buat Akun VMESS</h2>
        <div class="pill-row">
          <span class="pill">Protokol: VMESS</span>
          <span class="pill">Saldo diambil dari user_id backend</span>
        </div>

        <div class="field">
          <label for="server-select">Server</label>
          <select id="server-select">
            <option value="">Pilih server dari list kiri</option>
          </select>
        </div>

        <div class="field">
          <label for="username">Username (huruf & angka saja)</label>
          <input id="username" type="text" placeholder="contoh: extrimers01" autocomplete="off" />
          <div class="note">Tanpa spasi & simbol. Minimal 3 karakter, maksimal 20.</div>
        </div>

        <div class="field">
          <label for="days">Durasi Hari</label>
          <select id="days">
            <option value="7">7 Hari</option>
            <option value="15">15 Hari</option>
            <option value="30" selected>30 Hari</option>
          </select>
        </div>

        <div class="field">
          <label for="user-id">User ID (sementara fixed untuk test)</label>
          <input id="user-id" type="number" value="123456789" />
          <div class="note">Ini adalah user_id di database backend. Nanti bisa diganti sistem login.</div>
        </div>

        <button id="btn-order" class="primary">
          <span>üöÄ Buat Akun Sekarang</span>
        </button>
        <div id="status" class="note"></div>

        <div class="divider"></div>

        <div class="field">
          <label>Hasil / Config</label>
          <textarea id="result" readonly placeholder="Config VMESS atau pesan error akan muncul di sini..."></textarea>
          <div class="note">
            Jika sudah berhasil, copy config dan kirim ke customer.  
            Semua transaksi tetap tercatat di bot & database yang sama.
          </div>
        </div>
      </section>
    </main>
  </div>

  <footer>
    ExtrimerS Tunneling ‚Ä¢ Powered by API <span id="api-label-footer"></span>
  </footer>

  <script>
    // =====================
    // KONFIGURASI FRONTEND
    // =====================
    const API_BASE = "https://api.rmpremium.cloud"; // backend abang
    const orderEndpoint = API_BASE + "/api/web/order";
    const serversEndpoint = API_BASE + "/api/web/servers";

    document.getElementById("api-label").textContent = API_BASE;
    document.getElementById("api-label-footer").textContent = API_BASE;

    const serversDiv = document.getElementById("servers");
    const serverSelect = document.getElementById("server-select");
    const usernameInput = document.getElementById("username");
    const daysSelect = document.getElementById("days");
    const userIdInput = document.getElementById("user-id");
    const orderBtn = document.getElementById("btn-order");
    const resultArea = document.getElementById("result");
    const statusEl = document.getElementById("status");

    let serverList = [];

    // Load server di awal
    async function loadServers() {
      try {
        const res = await fetch(serversEndpoint);
        const data = await res.json();

        if (!data.success) {
          serversDiv.innerHTML = "<p style='color:#f97316;font-size:0.85rem;'>Gagal mengambil server: " + (data.error || "error tidak diketahui") + "</p>";
          return;
        }

        serverList = data.servers || [];
        if (!serverList.length) {
          serversDiv.innerHTML = "<p style='color:#9ca3af;font-size:0.85rem;'>Belum ada server terdaftar.</p>";
          return;
        }

        // Render grid kartu server
        serversDiv.innerHTML = "";
        serverSelect.innerHTML = "<option value=''>Pilih server‚Ä¶</option>";

        serverList.forEach(s => {
          const full = s.total_create_akun >= s.batas_create_akun;
          const serverCard = document.createElement("div");
          serverCard.className = "server-card";
          serverCard.innerHTML = `
            <div class="server-name">${s.nama_server}</div>
            <div class="location">${s.lokasi || "-"}</div>
            <div class="server-meta">
              Harga / hari: <b>Rp${(s.harga || 0).toLocaleString("id-ID")}</b><br/>
              Kuota / hari: <b>${s.quota} GB</b><br/>
              IP Limit: <b>${s.iplimit}</b><br/>
              Akun terbuat: <b>${s.total_create_akun}/${s.batas_create_akun}</b>
            </div>
            <div class="server-status ${full ? "status-full" : "status-ok"}">
              ${full ? "‚ùå PENUH" : "‚úÖ Tersedia"}
            </div>
          `;
          serverCard.addEventListener("click", () => {
            serverSelect.value = s.id;
          });
          serversDiv.appendChild(serverCard);

          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = `${s.nama_server} (${s.lokasi || "-"})`;
          serverSelect.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
        serversDiv.innerHTML = "<p style='color:#f97316;font-size:0.85rem;'>Gagal konek ke API server. Cek domain API / CORS.</p>";
      }
    }

    // Validasi username: hanya huruf dan angka, 3‚Äì20 karakter
    function validateUsername(u) {
      const re = /^[a-zA-Z0-9]{3,20}$/;
      return re.test(u);
    }

    async function handleOrder() {
      statusEl.textContent = "";
      statusEl.className = "note";
      resultArea.value = "";

      const serverId = serverSelect.value;
      const username = usernameInput.value.trim();
      const days = parseInt(daysSelect.value, 10);
      const userId = parseInt(userIdInput.value, 10);

      if (!serverId) {
        statusEl.textContent = "Pilih server terlebih dahulu.";
        statusEl.className = "error";
        return;
      }
      if (!username || !validateUsername(username)) {
        statusEl.textContent = "Username hanya boleh huruf & angka, 3‚Äì20 karakter, tanpa spasi/simbol.";
        statusEl.className = "error";
        return;
      }
      if (!userId) {
        statusEl.textContent = "User ID backend belum diisi.";
        statusEl.className = "error";
        return;
      }

      orderBtn.disabled = true;
      orderBtn.textContent = "Memproses...";
      statusEl.textContent = "Menghubungi server...";
      statusEl.className = "note";

      try {
        const res = await fetch(orderEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "create",
            type: "vmess",
            user_id: userId,
            server_id: Number(serverId),
            username: username,
            password: "123123", // tidak dipakai untuk VMESS, aman diisi statis
            days: days
          })
        });

        const data = await res.json();

        if (!data.success) {
          statusEl.textContent = "Gagal: " + (data.error || "error tidak diketahui");
          statusEl.className = "error";
          resultArea.value = data.error || "";
          return;
        }

        statusEl.textContent = "Berhasil! Harga: Rp" + (data.harga || 0).toLocaleString("id-ID") +
          (data.komisi ? (" ‚Ä¢ Komisi: Rp" + data.komisi.toLocaleString("id-ID")) : "");
        statusEl.className = "success";
        resultArea.value = data.message || "";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Gagal terhubung ke API. Cek jaringan / domain backend.";
        statusEl.className = "error";
      } finally {
        orderBtn.disabled = false;
        orderBtn.textContent = "üöÄ Buat Akun Sekarang";
      }
    }

    orderBtn.addEventListener("click", handleOrder);

    // Load server saat halaman dibuka
    loadServers();
  </script>
</body>
</html>
