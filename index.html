<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>ExtrimerS Tunneling - Simple Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #e5e7eb;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top, #020617, #000);
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }
    header {
      padding: 16px 0 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header span.brand-pill {
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(to right, #22c55e, #06b6d4);
      color: #020617;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }
    header small {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #1f2937;
      color: #9ca3af;
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 20px;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid #111827;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.85);
    }
    .card h2 {
      margin: 0 0 4px;
      font-size: 1.05rem;
    }
    .subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .servers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 12px;
    }
    .server-card {
      border-radius: 12px;
      padding: 12px;
      background: linear-gradient(to bottom right, #020617, #020617);
      border: 1px solid #1f2937;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }
    .server-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.8);
      border-color: #22c55e;
    }
    .server-card.selected {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
    }
    .server-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .location {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 6px;
    }
    .server-meta {
      font-size: 0.8rem;
      color: #9ca3af;
      line-height: 1.4;
    }
    .server-status {
      margin-top: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-ok { color: #22c55e; }
    .status-full { color: #ef4444; }

    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, #1f2937, transparent);
      margin: 12px 0;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    input, select, button, textarea {
      font-family: inherit;
      font-size: 0.9rem;
    }
    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      outline: none;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35);
    }
    .field {
      margin-bottom: 10px;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    .pill {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #9ca3af;
    }

    .tabs {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #1f2937;
      margin-bottom: 10px;
    }
    .tab-btn {
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.78rem;
      color: #9ca3af;
      background: transparent;
      cursor: pointer;
    }
    .tab-btn.active {
      background: linear-gradient(to right, #22c55e, #06b6d4);
      color: #020617;
      font-weight: 600;
    }

    .protocol-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 8px 0 12px;
    }
    .protocol-btn {
      flex: 1 1 70px;
      min-width: 70px;
      text-align: center;
      font-size: 0.78rem;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #9ca3af;
      cursor: pointer;
    }
    .protocol-btn.active {
      border-color: #22c55e;
      background: radial-gradient(circle at top, #0f172a, #022c22);
      color: #e5e7eb;
      font-weight: 600;
    }

    button.primary {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(to right, #22c55e, #06b6d4);
      color: #020617;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    button.primary:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .note {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 4px;
    }
    .error {
      color: #f97316;
      font-size: 0.8rem;
      margin-top: 4px;
    }
    .success {
      color: #22c55e;
      font-size: 0.8rem;
      margin-top: 4px;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      border-radius: 10px;
      padding: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      resize: vertical;
      box-sizing: border-box;
      font-size: 0.78rem;
      white-space: pre-wrap;
    }

    .result-card {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top, #020617, #020617);
      font-size: 0.78rem;
    }
    .result-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
      color: #9ca3af;
    }
    .result-row span:first-child {
      opacity: 0.8;
    }
    .result-highlight {
      font-weight: 600;
      color: #e5e7eb;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .chip {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #9ca3af;
    }
    .chip-success {
      border-color: #22c55e;
      color: #22c55e;
    }

    .copy-btn {
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
    }
    .copy-btn:hover {
      border-color: #22c55e;
    }

    footer {
      padding: 10px 16px 18px;
      text-align: center;
      font-size: 0.75rem;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>
          ‚ö° ExtrimerS Tunneling
          <span class="brand-pill">Simple Store</span>
        </h1>
        <small>Koneksi cepat & stabil ‚Ä¢ Sistem otomatis ‚Ä¢ Config langsung jadi</small>
      </div>
      <div>
        <span class="badge">API: <span id="api-label">loading‚Ä¶</span></span>
      </div>
    </header>

    <main>
      <!-- KIRI: LIST SERVER -->
      <section class="card">
        <h2>üì° Pilih Server</h2>
        <p class="subtitle">
          Tap salah satu server untuk digunakan. Status penuh artinya batas pembuatan akun harian sudah tercapai.
        </p>
        <div class="divider"></div>
        <div id="servers" class="servers-grid">
          <p style="font-size:0.85rem;color:#9ca3af;">Mengambil data server‚Ä¶</p>
        </div>
      </section>

      <!-- KANAN: FORM ORDER -->
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
          <h2>üßæ Panel Akun</h2>
          <div class="tabs">
            <button class="tab-btn active" data-tab="regular">Akun Reguler</button>
            <button class="tab-btn" data-tab="trial">Trial</button>
          </div>
        </div>
        <p class="subtitle" id="mode-desc">
          Mode reguler: saldo dipotong dari user_id backend sesuai harga & durasi.
        </p>

        <!-- PILIH PROTOKOL -->
        <label style="font-size:0.8rem;color:#9ca3af;">Protokol</label>
        <div class="protocol-row" id="protocol-row">
          <button class="protocol-btn active" data-protocol="vmess">VMESS</button>
          <button class="protocol-btn" data-protocol="vless">VLESS</button>
          <button class="protocol-btn" data-protocol="trojan">TROJAN</button>
          <button class="protocol-btn" data-protocol="ssh">SSH</button>
        </div>

        <!-- FORM -->
        <div class="field">
          <label for="server-select">Server</label>
          <select id="server-select">
            <option value="">Pilih server dari list kiri</option>
          </select>
          <div class="note">Atau tap kartu server di sebelah kiri untuk memilih otomatis.</div>
        </div>

        <div class="field">
          <label for="username">Username (huruf & angka, 3‚Äì20)</label>
          <input id="username" type="text" placeholder="contoh: extrimers01" autocomplete="off" />
        </div>

        <div class="field" id="password-field" style="display:none;">
          <label for="password">Password SSH</label>
          <input id="password" type="text" placeholder="Password untuk SSH" autocomplete="off" />
          <div class="note">Hanya dipakai untuk protokol SSH.</div>
        </div>

        <div class="field" id="days-field">
          <label for="days">Durasi Hari</label>
          <select id="days">
            <option value="7">7 Hari</option>
            <option value="15">15 Hari</option>
            <option value="30" selected>30 Hari</option>
          </select>
        </div>

        <div class="field" id="trial-days-field" style="display:none;">
          <label for="trial-days">Durasi Trial</label>
          <select id="trial-days">
            <option value="1" selected>1 Hari / 24 Jam</option>
            <option value="3">3 Hari</option>
          </select>
          <div class="note">Pastikan backend mengatur logika trial (misal free / kuota terbatas).</div>
        </div>

        <div class="field">
          <label for="user-id">User ID (ID di database backend)</label>
          <input id="user-id" type="number" value="123456789" />
        </div>

        <button id="btn-order" class="primary">
          <span id="btn-label">üöÄ Buat Akun Sekarang</span>
        </button>
        <div id="status" class="note"></div>

        <!-- HASIL -->
        <div class="divider"></div>

        <div>
          <div class="result-header">
            <span style="font-size:0.85rem;">Hasil Pembuatan Akun</span>
            <button class="copy-btn" id="copy-btn">Copy Config</button>
          </div>
          <div class="result-card" id="result-card">
            <div class="result-row">
              <span>Status</span>
              <span id="result-status" class="result-highlight">Belum ada permintaan.</span>
            </div>
            <div class="result-row">
              <span>Protokol</span>
              <span id="result-protocol">-</span>
            </div>
            <div class="result-row">
              <span>Server</span>
              <span id="result-server">-</span>
            </div>
            <div class="result-row">
              <span>Durasi</span>
              <span id="result-days">-</span>
            </div>
            <div class="result-row">
              <span>Harga</span>
              <span id="result-price">-</span>
            </div>
            <div class="result-row">
              <span>Komisi</span>
              <span id="result-komisi">-</span>
            </div>
          </div>

          <div class="field" style="margin-top:8px;">
            <label>Config / Detail Akun</label>
            <textarea id="result" readonly placeholder="Config VMESS / VLESS / TROJAN / SSH akan muncul di sini setelah akun berhasil dibuat."></textarea>
          </div>
        </div>
      </section>
    </main>
  </div>

  <footer>
    ExtrimerS Tunneling ‚Ä¢ Powered by <span id="api-label-footer"></span>
  </footer>

  <script>
    // =====================
    // KONFIGURASI FRONTEND
    // =====================
    const serversEndpoint = "/api/web/servers";
    const orderEndpoint   = "/api/web/order";

    document.getElementById("api-label").textContent = window.location.origin;
    document.getElementById("api-label-footer").textContent = window.location.origin;

    const serversDiv = document.getElementById("servers");
    const serverSelect = document.getElementById("server-select");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const daysSelect = document.getElementById("days");
    const trialDaysSelect = document.getElementById("trial-days");
    const userIdInput = document.getElementById("user-id");
    const orderBtn = document.getElementById("btn-order");
    const btnLabel = document.getElementById("btn-label");
    const statusEl = document.getElementById("status");
    const modeDesc = document.getElementById("mode-desc");
    const passwordField = document.getElementById("password-field");
    const daysField = document.getElementById("days-field");
    const trialDaysField = document.getElementById("trial-days-field");

    const resultArea = document.getElementById("result");
    const resultStatus = document.getElementById("result-status");
    const resultProtocol = document.getElementById("result-protocol");
    const resultServer = document.getElementById("result-server");
    const resultDays = document.getElementById("result-days");
    const resultPrice = document.getElementById("result-price");
    const resultKomisi = document.getElementById("result-komisi");
    const copyBtn = document.getElementById("copy-btn");

    const tabButtons = document.querySelectorAll(".tab-btn");
    const protocolButtons = document.querySelectorAll(".protocol-btn");

    let serverList = [];
    let selectedProtocol = "vmess";
    let mode = "regular"; // "regular" | "trial"

    // ================
    // LOAD SERVERS
    // ================
    async function loadServers() {
      try {
        const res = await fetch(serversEndpoint);
        const data = await res.json();

        if (!data.success) {
          serversDiv.innerHTML = "<p style='color:#f97316;font-size:0.85rem;'>Gagal mengambil server: " +
            (data.error || "error tidak diketahui") + "</p>";
          return;
        }

        serverList = data.servers || [];
        if (!serverList.length) {
          serversDiv.innerHTML = "<p style='color:#9ca3af;font-size:0.85rem;'>Belum ada server terdaftar.</p>";
          return;
        }

        serversDiv.innerHTML = "";
        serverSelect.innerHTML = "<option value=''>Pilih server‚Ä¶</option>";

        serverList.forEach((s) => {
          const full = s.total_create_akun >= s.batas_create_akun;
          const card = document.createElement("div");
          card.className = "server-card";
          card.dataset.id = s.id;
          card.innerHTML = `
            <div class="server-name">${s.nama_server}</div>
            <div class="location">${s.lokasi || "-"}</div>
            <div class="server-meta">
              Harga / hari: <b>Rp${(s.harga || 0).toLocaleString("id-ID")}</b><br/>
              Kuota / hari: <b>${s.quota} GB</b><br/>
              IP Limit: <b>${s.iplimit}</b><br/>
              Akun: <b>${s.total_create_akun}/${s.batas_create_akun}</b>
            </div>
            <div class="server-status ${full ? "status-full" : "status-ok"}">
              ${full ? "‚ùå PENUH" : "‚úÖ Tersedia"}
            </div>
          `;
          card.addEventListener("click", () => {
            serverSelect.value = s.id;
            document
              .querySelectorAll(".server-card")
              .forEach((c) => c.classList.remove("selected"));
            card.classList.add("selected");
          });
          serversDiv.appendChild(card);

          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = `${s.nama_server} (${s.lokasi || "-"})`;
          serverSelect.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
        serversDiv.innerHTML = "<p style='color:#f97316;font-size:0.85rem;'>Gagal konek ke API server. Cek domain API / proxy.</p>";
      }
    }

    loadServers();

    // ======================
    // PILIH PROTOKOL
    // ======================
    protocolButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        protocolButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        selectedProtocol = btn.dataset.protocol || "vmess";
        // SSH butuh password
        if (selectedProtocol === "ssh") {
          passwordField.style.display = "block";
        } else {
          passwordField.style.display = "none";
        }
      });
    });

    // ======================
    // TAB MODE (REGULER/TRIAL)
    // ======================
    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        tabButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        mode = btn.dataset.tab || "regular";

        if (mode === "regular") {
          modeDesc.textContent = "Mode reguler: saldo akan dipotong dari user_id backend sesuai harga & durasi.";
          daysField.style.display = "block";
          trialDaysField.style.display = "none";
          btnLabel.textContent = "üöÄ Buat Akun Sekarang";
        } else {
          modeDesc.textContent = "Mode trial: gunakan untuk percobaan. Pastikan backend mengatur logika trial (misalnya gratis / batas kuota).";
          daysField.style.display = "none";
          trialDaysField.style.display = "block";
          btnLabel.textContent = "üß™ Buat Akun Trial";
        }
      });
    });

    // ======================
    // VALIDASI USERNAME
    // ======================
    function validateUsername(u) {
      const re = /^[a-zA-Z0-9]{3,20}$/;
      return re.test(u);
    }

    // ======================
    // HANDLE ORDER
    // ======================
    async function handleOrder() {
      statusEl.textContent = "";
      statusEl.className = "note";
      resultArea.value = "";

      const serverId = serverSelect.value;
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim() || "123123"; // default
      const userId = parseInt(userIdInput.value, 10);

      const days =
        mode === "regular"
          ? parseInt(daysSelect.value, 10)
          : parseInt(trialDaysSelect.value, 10);

      if (!serverId) {
        statusEl.textContent = "Pilih server terlebih dahulu.";
        statusEl.className = "error";
        return;
      }
      if (!username || !validateUsername(username)) {
        statusEl.textContent = "Username hanya boleh huruf & angka, 3‚Äì20 karakter, tanpa spasi/simbol.";
        statusEl.className = "error";
        return;
      }
      if (selectedProtocol === "ssh" && password.trim().length < 3) {
        statusEl.textContent = "Password SSH minimal 3 karakter.";
        statusEl.className = "error";
        return;
      }
      if (!userId) {
        statusEl.textContent = "User ID backend belum diisi.";
        statusEl.className = "error";
        return;
      }

      orderBtn.disabled = true;
      btnLabel.textContent = mode === "regular" ? "Memproses..." : "Memproses Trial...";
      statusEl.textContent = "Menghubungi server...";
      statusEl.className = "note";

      try {
        const body = {
          action: "create",
          type: selectedProtocol,
          user_id: userId,
          server_id: Number(serverId),
          username: username,
          password: password,
          days: days,
        };

        // flag tambahan supaya backend bisa bedakan trial kalau mau
        if (mode === "trial") {
          body.is_trial = true;
        }

        const res = await fetch(orderEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const data = await res.json();

        if (!data.success) {
          statusEl.textContent = "Gagal: " + (data.error || "error tidak diketahui");
          statusEl.className = "error";
          resultStatus.textContent = "Gagal";
          resultStatus.style.color = "#f97316";
          return;
        }

        // STATUS TEXT
        statusEl.textContent =
          (mode === "trial" ? "Trial berhasil! " : "Berhasil! ") +
          "Harga: Rp" +
          (data.harga || 0).toLocaleString("id-ID") +
          (data.komisi ? " ‚Ä¢ Komisi: Rp" + data.komisi.toLocaleString("id-ID") : "");
        statusEl.className = "success";

        // DETAIL RESULT
        const server = serverList.find((s) => String(s.id) === String(serverId));

        resultStatus.textContent = "Berhasil";
        resultStatus.style.color = "#22c55e";
        resultProtocol.textContent = selectedProtocol.toUpperCase() + (mode === "trial" ? " (TRIAL)" : "");
        resultServer.textContent = server ? server.nama_server : "-";
        resultDays.textContent = days + " hari";
        resultPrice.textContent = "Rp" + (data.harga || 0).toLocaleString("id-ID");
        resultKomisi.textContent = data.komisi
          ? "Rp" + data.komisi.toLocaleString("id-ID")
          : "-";

        resultArea.value = data.message || "(Config tidak dikembalikan oleh server)";

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Gagal terhubung ke API. Cek jaringan / domain backend.";
        statusEl.className = "error";
        resultStatus.textContent = "Error koneksi";
        resultStatus.style.color = "#f97316";
      } finally {
        orderBtn.disabled = false;
        btnLabel.textContent = mode === "regular" ? "üöÄ Buat Akun Sekarang" : "üß™ Buat Akun Trial";
      }
    }

    orderBtn.addEventListener("click", handleOrder);

    // ======================
    // COPY CONFIG
    // ======================
    copyBtn.addEventListener("click", async () => {
      const text = resultArea.value.trim();
      if (!text) {
        alert("Belum ada config yang bisa di-copy.");
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = "Tersalin!";
        setTimeout(() => (copyBtn.textContent = "Copy Config"), 1200);
      } catch {
        alert("Gagal menyalin ke clipboard. Silakan pilih & copy manual.");
      }
    });
  </script>
</body>
  </html>
